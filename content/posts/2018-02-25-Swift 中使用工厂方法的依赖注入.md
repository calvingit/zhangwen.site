---
title: Swift ä¸­ä½¿ç”¨å·¥å‚æ–¹æ³•çš„ä¾èµ–æ³¨å…¥
slug: dependency-injection-using-factories-in-swift
date: 2018-02-25
categories:
  - iOS
tags:
  - Swift
toc: true
---

ä¾èµ–æ³¨å…¥çš„å¥½å¤„æš‚ä¸”ä¸è¡¨ï¼Œå¤§å®¶éƒ½çŸ¥é“ã€‚æœ€æ™®éçš„åšæ³•æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥å®ƒæ‰€éœ€è¦çš„æ‰€æœ‰ä¾èµ–ï¼Œä½†æ˜¯ç¢°åˆ°ä¸‹é¢è¿™ç§æƒ…å†µï¼Œä½ å°±ä¼šæ„Ÿè§‰å¾ˆè›‹ç–¼äº†ï¼š

```swift
class UserManager {
    init(dataLoader: DataLoader, database: Database, cache: Cache,
         keychain: Keychain, tokenManager: TokenManager) {
        ...
    }
}
```

<!-- more -->

è¿™å°±å¯¼è‡´äº†ä¸€ä¸ª**Massive**çš„åˆå§‹åŒ–å™¨ï¼Œä»¥åŠå¤æ‚çš„ä¾èµ–ç®¡ç†é—®é¢˜ã€‚

## ä¼ é€’ä¾èµ–

åœ¨ä½¿ç”¨ä¾èµ–æ³¨å…¥æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸é™·å…¥ä¸Šé¢è¿™ç§æƒ…å†µï¼ŒåŸå› æ˜¯ä¸ºäº†ä»¥åå¯èƒ½è¦ç”¨åˆ°å®ƒï¼Œé‚£æˆ‘ä»¬å°±å¿…é¡»ä¼ é€’ä¸‹å»ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸ª`MessageListViewController`æ¶ˆæ¯ç±»ï¼Œå®ƒä¾èµ–`MessageLoader`ï¼Œç”¨æ¥åŠ è½½æ‰€æœ‰æ¶ˆæ¯ï¼š

```swift
class MessageListViewController: UITableViewController {
    private let loader: MessageLoader

    init(loader: MessageLoader) {
        self.loader = loader
        super.init(nibName: nil, bundle: nil)
    }

    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)

        loader.load { [weak self] messages in
            self?.reloadTableView(with: messages)
        }
    }
}
```

ç›®å‰çœ‹æ¥é—®é¢˜ä¸å¤§ï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€ä¸ªä¾èµ–ã€‚ç„¶è€Œï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦åœ¨ç‚¹å‡»åˆ—è¡¨é¡¹æ—¶ï¼Œå¯¼èˆªåˆ°ä¸‹ä¸€ä¸ªè§†å›¾`MessageViewController`ï¼Œè®©ç”¨æˆ·æŸ¥çœ‹æ¶ˆæ¯è¯¦æƒ…ï¼Œå¹¶ä¸”å›å¤æ¶ˆæ¯ã€‚ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª`MessageSender`æ¶ˆæ¯å‘é€ç±»ï¼Œæ³¨å…¥åˆ°`MessageViewController`ï¼Œå°±åƒè¿™æ ·ï¼š

```swift
override func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
    let message = messages[indexPath.row]
    let viewController = MessageViewController(message: message, sender: sender)
    navigationController?.pushViewController(viewController, animated: true)
}
```

é—®é¢˜æ¥äº†ï¼Œå› ä¸º`MessageViewController`éœ€è¦ä¸€ä¸ª`MessageSender`çš„å®ä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—è®©`MessageListViewController`çŸ¥æ™“æœ‰è¿™ä¹ˆä¸€ä¸ªç±»ã€‚æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ï¼Œåœ¨`MessageListViewController`åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¹Ÿæ·»åŠ ä¸€ä¸ª`sender`ï¼š

```swift
class MessageListViewController: UITableViewController {
    init(loader: MessageLoader, sender: MessageSender) {
        ...
    }
}
```

è™½ç„¶ä¸Šé¢çš„ä»£ç å¯ä»¥å·¥ä½œï¼Œä½†æ˜¯å®ƒè®©æˆ‘ä»¬èµ°å…¥äº†`Massive`åˆå§‹åŒ–å™¨çš„é“è·¯ä¸Šï¼Œä½¿`MessageListViewController`æ›´éš¾ç”¨äº†ï¼ˆå¥½å¥‡çš„æ˜¯ï¼Œä¸ºä»€ä¹ˆåˆ—è¡¨ä¸€å¼€å§‹å°±è¦å…³å¿ƒ`sender`ï¼Ÿï¼‰ã€‚

å¦å¤–ä¸€ä¸ªæ™®éçš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨å•ä¾‹ï¼Œåˆ°å¤„éƒ½å¯ä»¥è®¿é—®ï¼Œè€Œä¸”å¾ˆæ–¹ä¾¿ï¼š

```swift
let viewController = MessageViewController(
    message: message,
    sender: MessageSender.shared
)
```

ä½†æ˜¯ï¼Œæˆ‘ä»¬å¿…é¡»[é¿å…ä½¿ç”¨å•ä¾‹](https://www.swiftbysundell.com/posts/avoiding-singletons-in-swift)ã€‚å•ä¾‹æ–¹æ³•ä¼´éšç€å¾ˆå¤šé‡å¤§çš„ç¼ºç‚¹ï¼Œä¼šè®©æˆ‘ä»¬å¾ˆéš¾ç†è§£ä¸æ¸…æ¥šçš„ä¾èµ–æ¶æ„ã€‚

## å·¥å‚æ–¹æ³•é‡ç”¨

å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿè·³è¿‡ä¸Šé¢çš„æ‰€æœ‰æ­¥éª¤ï¼Œè®©`MessageListViewController`å®Œå…¨ä¸éœ€è¦å…³å¿ƒ`MessageSender`ï¼Œä»¥åŠéšåçš„è§†å›¾æ§åˆ¶å™¨éœ€è¦çš„æ‰€æœ‰å…¶ä»–ä¾èµ–ï¼Œé‚£å°±æ£’æäº†ã€‚

æˆ‘ä»¬å¯ä»¥æœ‰æŸç§å½¢å¼çš„å·¥å‚æ–¹æ³•ï¼Œç®€å•åœ°è¯·æ±‚ä¸€ä¸ª`message`å‚æ•°æ¥åˆ›å»ºä¸€ä¸ª`MessageViewController`ï¼Œå°±åƒè¿™æ ·ï¼š

```Swift
let viewController = factory.makeMessageViewController(for: message)
```

å°±åƒæˆ‘ä»¬åœ¨[ä½¿ç”¨å·¥å‚æ¨¡å¼é¿å…å…±äº«çŠ¶æ€](https://www.swiftbysundell.com/posts/using-the-factory-pattern-to-avoid-shared-state-in-swift?rq=factories)ä¸­è¯´è¿‡çš„ä¸€æ ·ï¼Œå·¥å‚æ–¹æ³•å¯ä»¥è®©ä½ å®Œå…¨è§£è€¦ä¸€ä¸ªå¯¹è±¡çš„**ä½¿ç”¨**å’Œ**åˆ›å»º**ã€‚å½“ä½ æƒ³è¦é‡æ„æˆ–è€…æ”¹å˜ä¸€äº›ä¸œè¥¿æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•èƒ½ä½¿å¾ˆå¤šå¯¹è±¡ä¸å®ƒä»¬çš„ä¾èµ–ä¿æŒä¸€ç§å®½æ¾çš„è€¦åˆå…³ç³»ã€‚

### å¦‚ä½•åšåˆ°å‘¢ï¼Ÿ

æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªåè®®ï¼Œç”¨æ¥åˆ›å»º App å†…éœ€è¦çš„è§†å›¾æ§åˆ¶å™¨ï¼Œå®ƒå¹¶ä¸éœ€è¦çŸ¥é“å…³äºä¾èµ–å’Œåˆå§‹åŒ–å™¨çš„ä»»ä½•ä¸œè¥¿ï¼š

```Swift
protocol ViewControllerFactory {
    func makeMessageListViewController() -> MessageListViewController
    func makeMessageViewController(for message: Message) -> MessageViewController
}
```

æ¥ç€ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå·¥å‚åè®®ï¼Œç”¨æ¥åˆ›å»ºä¾èµ–`MessageLoader`ï¼š

```swift
protocol MessageLoaderFactory {
    func makeMessageLoader() -> MessageLoader
}
```

### å•ä¸€ä¾èµ–

å½“å·¥å‚åè®®å‡†å¤‡å¥½ä¹‹åï¼Œæˆ‘ä»¬å›åˆ°`MessageListViewController`ï¼Œç”¨ä¸€ä¸ª factory æ¥æ›¿ä»£ä¾èµ–å®ä¾‹ï¼š

```Swift
class MessageListViewController: UITableViewController {
    // Here we use protocol composition to create a Factory type that includes
    // all the factory protocols that this view controller needs.
    typealias Factory = MessageLoaderFactory & ViewControllerFactory

    private let factory: Factory
    // We can now lazily create our MessageLoader using the injected factory.
    private lazy var loader = factory.makeMessageLoader()

    init(factory: Factory) {
        self.factory = factory
        super.init(nibName: nil, bundle: nil)
    }
}
```

ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®Œæˆäº†ä¸¤ä»¶äº‹ï¼š

1. å°†ä¾èµ–åˆ—è¡¨ç¼©å‡åˆ°å•ä¸ªå·¥å‚
2. `MessageListViewController`ç°åœ¨ä¸éœ€è¦å…³å¿ƒ`MessageViewController`çš„ä¾èµ–äº†

### ä¾èµ–å®¹å™¨

ç°åœ¨åˆ°äº†å®ç°å·¥å‚åè®®çš„æ—¶å€™äº†ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ª`DependencyContainer`ï¼Œå®ƒåŒ…å«äº† App å†…çš„æ‰€æœ‰éœ€è¦æ³¨å…¥çš„ä¾èµ–ï¼ŒåŒ…æ‹¬`MessageSender`ã€‚å¯èƒ½è¿˜æœ‰æ›´åº•å±‚é€»è¾‘çš„ç±»ï¼Œæ¯”å¦‚`NetworkManager`ã€‚

```Swift
class DependencyContainer {
    private lazy var messageSender = MessageSender(networkManager: networkManager)
    private lazy var networkManager = NetworkManager(urlSession: .shared)
}
```

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨`lazy`å±æ€§æ¥å®šä¹‰ä¾èµ–å®ä¾‹ï¼Œä¾èµ–åœ¨åˆå§‹åŒ–å¯¹è±¡æ—¶å¼•ç”¨åŒç±»çš„å…¶ä»–å±æ€§ï¼Œè€Œä¸”å®ƒè¿˜èƒ½å¸®åŠ©æˆ‘ä»¬é¿å…[å¾ªç¯ä¾èµ–](https://en.wikipedia.org/wiki/Circular_dependency)ã€‚

æœ€åï¼Œæˆ‘ä»¬è®©ä¾èµ–å®¹å™¨éµå¾ªå·¥å‚åè®®ï¼š

```Swift
extension DependencyContainer: ViewControllerFactory {
    func makeMessageListViewController() -> MessageListViewController {
        return MessageListViewController(factory: self)
    }

    func makeMessageViewController(for message: Message) -> MessageViewController {
        return MessageViewController(message: message, sender: messageSender)
    }
}

extension DependencyContainer: MessageLoaderFactory {
    func makeMessageLoader() -> MessageLoader {
        return MessageLoader(networkManager: networkManager)
    }
}
```

### åˆ†æ•£çš„æ‰€æœ‰æƒ

æ¥ä¸‹æ¥æˆ‘ä»¬å¾—æ€è€ƒå‡ ä¸ªç»ˆæé—®é¢˜ï¼š

- åœ¨å“ªé‡Œå­˜å‚¨ä¾èµ–å®¹å™¨ï¼Ÿ
- è°æ‹¥æœ‰ä¾èµ–å®¹å™¨ï¼Ÿ
- åœ¨å“ªé‡Œé…ç½®ä¾èµ–å®¹å™¨ï¼Ÿ

è¿™æ˜¯ä¸ªå¾ˆæœ‰æ„æ€çš„äº‹æƒ…ï¼šå› ä¸ºæˆ‘ä»¬æŠŠä¾èµ–å®¹å™¨æ³¨å…¥åˆ°å¯¹è±¡æ‰€éœ€çš„å·¥å‚çš„å®ç°ä¸­ï¼Œå¹¶ä¸”ç”±äºè¿™äº›å¯¹è±¡å¯¹å…¶å·¥å‚æ˜¯å¼ºå¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å°†å®¹å™¨å­˜å‚¨åœ¨ä»»ä½•åœ°æ–¹ ğŸ‘ã€‚

æ¯”æ–¹è¯´ï¼Œ`MessageListViewController`æ˜¯ App çš„æ ¹è§†å›¾æ§åˆ¶å™¨ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ª`DependencyContainer`å®ä¾‹ï¼Œç„¶åä¼ è¿‡å»å³å¯ï¼š

```Swift
let container = DependencyContainer()
let listViewController = container.makeMessageListViewController()

window.rootViewController = UINavigationController(
    rootViewController: listViewController
)
```

å®Œå…¨æ²¡æœ‰å¿…è¦ä¿å­˜ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæˆ–è€…åœ¨ app delegate ä¸­ä½¿ç”¨å¯é€‰å±æ€§ã€‚

## ç»“è®º

ä½¿ç”¨å·¥å‚åè®®å’Œå®¹å™¨çš„æ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œå¯ä»¥é¿å…ä¼ é€’å¤šä¸ªä¾èµ–å’Œåˆ›å»ºå¤æ‚çš„åˆå§‹åŒ–å™¨ã€‚è™½ç„¶è¿™å¹¶ä¸æ˜¯é“¶å¼¹ï¼Œä½†æ˜¯èƒ½å¤Ÿè®©ä¾èµ–æ³¨å…¥æ›´ç®€å•ï¼Œè¿™å°†ä½¿æ‚¨å¯¹å¯¹è±¡çš„å®é™…ä¾èµ–å…³ç³»æœ‰ä¸€ä¸ªæ›´æ¸…æ™°çš„äº†è§£ï¼Œè€Œä¸”ç®€åŒ–æµ‹è¯•ã€‚

å› ä¸ºæˆ‘ä»¬å°†æ‰€æœ‰å·¥å‚å®šä¹‰ä¸ºåè®®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ä¸­é€šè¿‡å®ç°ä»»ä½•ç»™å®šçš„å·¥å‚åè®®çš„ç‰¹å®šç‰ˆæœ¬æ¥æ¨¡æ‹Ÿå®ƒä»¬ã€‚

> é˜…è¯»[åŸæ–‡](https://www.swiftbysundell.com/posts/dependency-injection-using-factories-in-swift)ï¼Œä½œè€…æ˜¯[John Sundell](https://twitter.com/johnsundell)
